{
  "rules": {
    "rooms": {
      ".read": true,
      ".write": "auth != null",
      ".indexOn": ["createdAt"],
      
      "$roomId": {
        ".read": true,
        ".write": "auth != null",
        
        "name": {
          ".validate": "newData.isString() && newData.val().length >= 2 && newData.val().length <= 100"
        },
        
        "videoUrl": {
          ".validate": "newData.isString() || newData.val() === null"
        },
        
        "originalUrl": {
          ".validate": "newData.isString() || newData.val() === null"
        },
        
        "videoService": {
          ".validate": "newData.isString() || newData.val() === null"
        },
        
        "environment": {
          ".validate": "newData.isString() && newData.val().matches(/^(none|theater|space|forest|desert|moon|cyberpunk|underwater|mountain|volcano|fantasy|city|beach)$/)"
        },
        
        "controlMode": {
          ".validate": "newData.isString() && newData.val().matches(/^(owner|everyone)$/)"
        },
        
        "isPrivate": {
          ".validate": "newData.isBoolean()"
        },
        
        "password": {
          ".validate": "newData.isString() || newData.val() === null"
        },
        
        "screenSize": {
          ".validate": "newData.isString() && newData.val().matches(/^(normal|large|xlarge|imax)$/)"
        },
        
        "owner": {
          ".validate": "newData.isString() || newData.val() === null"
        },
        
        "ownerNickname": {
          ".validate": "newData.isString() && newData.val().length >= 2 && newData.val().length <= 20"
        },
        
        "members": {
          ".validate": "newData.hasChildren()",
          "$memberId": {
            ".validate": "newData.isString()"
          }
        },
        
        "createdAt": {
          ".validate": "newData.isNumber()"
        },
        
        "videoState": {
          ".write": "auth != null",
          "isPlaying": {
            ".validate": "newData.isBoolean()"
          },
          "currentTime": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          },
          "lastUpdate": {
            ".validate": "newData.isNumber()"
          },
          "startTimestamp": {
            ".validate": "newData.isNumber() || newData.val() === null"
          }
        },
        
        "screenPosition": {
          ".write": "auth != null",
          "x": {
            ".validate": "newData.isNumber() && newData.val() >= -50 && newData.val() <= 50"
          },
          "y": {
            ".validate": "newData.isNumber() && newData.val() >= -10 && newData.val() <= 30"
          },
          "z": {
            ".validate": "newData.isNumber() && newData.val() >= -50 && newData.val() <= 10"
          }
        },
        
        "viewers": {
          ".validate": "newData.isNumber() && newData.val() >= 0"
        },
        
        "messages": {
          ".read": true,
          ".write": "auth != null",
          "$messageId": {
            ".validate": "newData.hasChildren(['userId', 'nickname', 'message', 'timestamp'])",
            "userId": {
              ".validate": "newData.isString() && newData.val() === auth.uid"
            },
            "nickname": {
              ".validate": "newData.isString() && newData.val().length >= 2 && newData.val().length <= 20"
            },
            "message": {
              ".validate": "newData.isString() && newData.val().length >= 1 && newData.val().length <= 200"
            },
            "timestamp": {
              ".validate": "newData.isNumber() && newData.val() <= now + 10000"
            }
          }
        }
      }
    },
    
    "users": {
      "$userId": {
        ".read": "auth != null && auth.uid === $userId",
        ".write": "auth != null && auth.uid === $userId",
        
        "nickname": {
          ".validate": "newData.isString() && newData.val().length >= 2 && newData.val().length <= 20"
        },
        
        "lastSeen": {
          ".validate": "newData.isNumber()"
        }
      }
    },
    
    ".read": false,
    ".write": false
  }
}